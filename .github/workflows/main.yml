name: CI-CD-Pipeline-Local-IIS-Azure

# üéØ Define Triggers
on:
  push:
    branches:
      - 'Feature/**'
  pull_request:
    branches:
      - 'development'
      - 'main'
  workflow_dispatch:
    inputs:
      sha_id:
        description: 'SHA of the commit to deploy (used to fetch artifact)'
        required: true
        type: string
      environment:
        description: 'Target Environment (must be development)'
        required: true
        type: environment

env:
  DOTNET_CORE_VERSION: 8.0.x
  SOLUTION_PATH: Agentic-Ai-ClaimsService.sln
  PROJECT_PATH: ClaimsServiceApi/Health.Claims.Service.Api/Health.Claims.Service.Api.csproj
  ARTIFACT_NAME: ClaimsServiceApiBinaries
  ACR_REGISTRY_NAME: devhealthclaimscontainerregistry.azurecr.io
  ACR_REPOSITORY: claims-service-api

jobs:
  # --------------------------------------------------------------------
  # üèóÔ∏è BUILD STAGE
  # --------------------------------------------------------------------
  build:
    name: 1Ô∏è‚É£ Build Stage
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/Feature/')) ||
      (github.event_name == 'pull_request' && (github.base_ref == 'development' || github.base_ref == 'main'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_CORE_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore Solution
        run: dotnet restore ${{ env.SOLUTION_PATH }} --verbosity normal

      - name: Build Solution
        run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore --verbosity normal

      - name: Publish .NET Application
        run: dotnet publish ${{ env.PROJECT_PATH }} --configuration Release --output ${{ runner.temp }}/publish_output

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: ${{ runner.temp }}/publish_output
          retention-days: 7

  # --------------------------------------------------------------------
  # üß™ TEST STAGE
  # --------------------------------------------------------------------
  test:
    name: 2Ô∏è‚É£ Test Stage
    runs-on: ubuntu-latest
    needs: build
    if: success()
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_CORE_VERSION }}

      - name: Run Domain Tests
        run: dotnet test "ClaimsServiceApi/Health.CLaims.Service.Domain.Tests/Health.CLaims.Service.Domain.Tests.csproj" --configuration Release

      - name: Run Infrastructure Tests
        run: dotnet test "ClaimsServiceApi/Health.Claims.Service.Infrastructure.Tests/Health.Claims.Service.Infrastructure.Tests.csproj" --configuration Release

  # --------------------------------------------------------------------
  # üü¢ FEATURE DEPLOY (Local IIS)
  # --------------------------------------------------------------------
  feature-deploy:
    name: 3A üíæ Approval Gated Deploy to Local Feature IIS
    needs: test
    if: success() && github.event_name == 'push' && startsWith(github.ref, 'refs/heads/Feature/')
    runs-on: self-hosted
    environment: Feature-Staging
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: deploy_target

      - name: Deploy to Local IIS
        shell: powershell
        run: |
          $appcmdPath = "C:\Windows\System32\inetsrv\appcmd.exe"
          $iisTargetFolder = "F:\Work\Personal\Deployment\ClaimServiceApi\local"
          $appPoolName = "AspNetCore"
          $websiteName = "ClaimsServiceLocal"

          # Ensure WAS service is running
          if ((Get-Service W3SVC).Status -ne 'Running') { Start-Service W3SVC -ErrorAction Stop }

          # Create or update App Pool
          if (-not (& $appcmdPath list apppool /name:$appPoolName -ErrorAction SilentlyContinue)) {
              & $appcmdPath add apppool /name:$appPoolName /managedRuntimeVersion:"" /enable32BitAppOnWin64:"false"
          }
          & $appcmdPath set apppool /apppool.name:$appPoolName /managedRuntimeVersion:"" /enable32BitAppOnWin64:"false"
          try { & $appcmdPath stop apppool /apppool.name:$appPoolName } catch {}

          # Prepare deployment folder
          if (-not (Test-Path $iisTargetFolder)) { New-Item -ItemType Directory -Force -Path $iisTargetFolder }
          else { Remove-Item -Path "$iisTargetFolder\*" -Force -Recurse -ErrorAction SilentlyContinue }

          Copy-Item -Path "deploy_target\*" -Destination $iisTargetFolder -Recurse

          # Copy web.config
          $webConfigSource = Join-Path $env:GITHUB_WORKSPACE "ClaimsServiceApi\Health.Claims.Service.Api\web.config.development"
          if (Test-Path $webConfigSource) { Copy-Item -Path $webConfigSource -Destination (Join-Path $iisTargetFolder "web.config") -Force }

          & $appcmdPath start apppool /apppool.name:$appPoolName

  # --------------------------------------------------------------------
  # üü° DEV IIS TRIGGER (Approval Gate)
  # --------------------------------------------------------------------
  dev-iis-trigger:
    name: 3B üíæ Dev IIS Deployment Trigger
    needs: test
    runs-on: ubuntu-latest
    if: success() && github.event_name == 'pull_request' && github.base_ref == 'development'
    steps:
      - name: Trigger Dev Deployment Workflow
        uses: benc-uk/workflow-dispatch-action@v1
        with:
          workflow: ${{ github.workflow }}
          ref: ${{ github.base_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          inputs: |
            { 
              "sha_id": "${{ github.sha }}",
              "environment": "development" 
            }

  # --------------------------------------------------------------------
  # üü° DEV DEPLOY APPROVED
  # --------------------------------------------------------------------
  dev-deploy-approved:
    name: 4Ô∏è‚É£ üîí Approved Deploy to Dev Branch IIS
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'development'
    runs-on: self-hosted
    environment: Development-Staging
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.event.inputs.sha_id }}
          path: deploy_target

      - name: Deploy to Local IIS
        shell: powershell
        run: |
          $appcmdPath = "C:\Windows\System32\inetsrv\appcmd.exe"
          $iisTargetFolder = "F:\Work\Personal\Deployment\ClaimServiceApi\development"
          $appPoolName = "DevBranchClaimsService"
          $websiteName = "ClaimsServiceDevBranch"

          if ((Get-Service W3SVC).Status -ne 'Running') { Start-Service W3SVC -ErrorAction Stop }

          if (-not (& $appcmdPath list apppool /name:$appPoolName -ErrorAction SilentlyContinue)) {
              & $appcmdPath add apppool /name:$appPoolName /managedRuntimeVersion:"" /enable32BitAppOnWin64:"false"
          }
          & $appcmdPath set apppool /apppool.name:$appPoolName /managedRuntimeVersion:"" /enable32BitAppOnWin64:"false"
          try { & $appcmdPath stop apppool /apppool.name:$appPoolName } catch {}

          if (-not (Test-Path $iisTargetFolder)) { New-Item -ItemType Directory -Force -Path $iisTargetFolder }
          else { Remove-Item -Path "$iisTargetFolder\*" -Force -Recurse -ErrorAction SilentlyContinue }

          Copy-Item -Path "deploy_target\*" -Destination $iisTargetFolder -Recurse

          $webConfigSource = Join-Path $env:GITHUB_WORKSPACE "ClaimsServiceApi\Health.Claims.Service.Api\web.config.Development"
          if (Test-Path $webConfigSource) { Copy-Item -Path $webConfigSource -Destination (Join-Path $iisTargetFolder "web.config") -Force }

          & $appcmdPath start apppool /apppool.name:$appPoolName

  # --------------------------------------------------------------------
  # üî¥ MAIN ACR PUSH
  # --------------------------------------------------------------------
  main-acr-push:
    name: 3C üê≥ Main ACR Push Stage
    needs: test
    runs-on: ubuntu-latest
    if: success() && github.event_name == 'pull_request' && github.base_ref == 'main'
    environment: Production
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Azure Login for ACR
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: true

      - name: Build and Push Docker Image to ACR
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ClaimsServiceApi/Health.Claims.Service.Api/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_REGISTRY_NAME }}/${{ env.ACR_REPOSITORY }}:${{ github.sha }}
            ${{ env.ACR_REGISTRY_NAME }}/${{ env.ACR_REPOSITORY }}:latest



