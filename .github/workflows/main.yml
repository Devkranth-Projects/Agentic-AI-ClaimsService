name: CI-CD-Pipeline-Local-IIS-Azure

on:
  push:
    branches:
      - "Feature/**"
      - "Bug/**"

  pull_request:
    branches:
      - "Development"
      - "main"

  workflow_dispatch:
    inputs:
      sha_id:
        description: "Commit SHA to deploy"
        required: true
        type: string
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - Development
          - Production

env:
  ARTIFACT_NAME: ClaimsServiceApiBinaries

jobs:

  build-test:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && (startsWith(github.ref, 'refs/heads/Feature/') || startsWith(github.ref, 'refs/heads/Bug/'))) ||
      (github.event_name == 'pull_request')
    steps:
      - uses: actions/checkout@v4
      - name: Log Branch & Commit Info
        run: |
          echo "==============================================="
          echo "ðŸ”¹ GitHub Branch: $GITHUB_REF"
          echo "ðŸ”¹ Commit SHA: $GITHUB_SHA"
          echo "==============================================="

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore Dependencies
        run: |
          echo "ðŸŸ¢ Step 1: Starting NuGet restore..."
          echo "ðŸ”¹ Solution path: Agentic-Ai-ClaimsService.sln"
          dotnet restore Agentic-Ai-ClaimsService.sln
          echo "âœ… NuGet restore completed successfully."

      - name: Build Solution
        run: |
          echo "ðŸŸ¢ Step 2: Building the solution..."
          echo "ðŸ”¹ Configuration: Release"
          echo "ðŸ”¹ Solution path: Agentic-Ai-ClaimsService.sln"
          dotnet build Agentic-Ai-ClaimsService.sln -c Release --no-restore
          echo "âœ… Build completed successfully."

      - name: Publish Project
        run: |
          echo "ðŸŸ¢ Step 3: Publishing project to temporary folder..."
          echo "ðŸ”¹ Project path: ClaimsServiceApi/Health.Claims.Service.Api/Health.Claims.Service.Api.csproj"
          echo "ðŸ”¹ Output folder: ${{ runner.temp }}/publish_output"
          dotnet publish ClaimsServiceApi/Health.Claims.Service.Api/Health.Claims.Service.Api.csproj -c Release -o ${{ runner.temp }}/publish_output
          $fileCount = (Get-ChildItem -Recurse -Path ${{ runner.temp }}/publish_output).Count
          echo "ðŸ”¹ Published $fileCount files."
          echo "âœ… Publish completed successfully."

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: ${{ runner.temp }}/publish_output

  test:
    needs: build-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Run Domain Tests
        run: |
          echo "ðŸŸ¢ Step 4: Running Domain Test Cases..."
          echo "ðŸ”¹ Project: ClaimsServiceApi/Health.CLaims.Service.Domain.Tests"
          dotnet test "ClaimsServiceApi/Health.CLaims.Service.Domain.Tests/Health.CLaims.Service.Domain.Tests.csproj" -c Release --logger "console;verbosity=detailed"
          echo "âœ… Domain Tests completed successfully."

      - name: Run Infrastructure Tests
        run: |
          echo "ðŸŸ¢ Step 5: Running Infrastructure Test Cases..."
          echo "ðŸ”¹ Project: ClaimsServiceApi/Health.Claims.Service.Infrastructure.Tests"
          dotnet test "ClaimsServiceApi/Health.Claims.Service.Infrastructure.Tests/Health.Claims.Service.Infrastructure.Tests.csproj" -c Release --logger "console;verbosity=detailed"
          echo "âœ… Infrastructure Tests completed successfully."

  feature-deploy:
    needs: test
    runs-on: self-hosted
    if: github.event_name == 'push' && (startsWith(github.ref, 'refs/heads/Feature/') || startsWith(github.ref, 'refs/heads/Bug/'))
    environment: Local
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: deploy_target

      - name: Deploy to IIS (Local)
        shell: powershell
        run: |
          Write-Host "ðŸŸ¢ Step 6: Starting deployment to Local IIS..."
          Write-Host "ðŸ”¹ Deployment target folder: F:\Work\Personal\Deployment\ClaimServiceApi\Local"
          $envName = "Local"
          $appcmd = "C:\Windows\System32\inetsrv\appcmd.exe"
          $targetPath = "F:\Work\Personal\Deployment\ClaimServiceApi\$envName"

          # AppPool Status
          if (Get-Service W3SVC).Status -eq 'Running' { Write-Host "ðŸ”¹ IIS service is running." } else { Write-Host "âš ï¸ IIS service is not running. Starting service..."; Start-Service W3SVC }

          if (Test-Path $targetPath) { 
              Write-Host "ðŸ”¹ Cleaning existing deployment folder..."
              Remove-Item "$targetPath\*" -Recurse -Force
          } else { 
              Write-Host "ðŸ”¹ Creating deployment folder..."
              New-Item -Path $targetPath -ItemType Directory 
          }

          $fileCount = (Get-ChildItem -Path deploy_target -Recurse).Count
          Write-Host "ðŸ”¹ Copying $fileCount files from publish output..."
          Copy-Item "deploy_target\*" $targetPath -Recurse -Force

          # Replace web.config
          $envConfig = Join-Path $targetPath "web.config.$envName"
          $mainConfig = Join-Path $targetPath "web.config"
          Write-Host "ðŸ”¹ Checking for environment-specific web.config..."
          if (Test-Path $mainConfig) { Remove-Item $mainConfig -Force; Write-Host "ðŸ”¹ Removed existing web.config" }
          if (Test-Path $envConfig) { Copy-Item $envConfig $mainConfig -Force; Write-Host "ðŸ”¹ Copied $envConfig â†’ $mainConfig" } else { Write-Host "âš ï¸ Environment-specific web.config not found!" }

          # Restart AppPool
          Write-Host "ðŸ”¹ Restarting AppPool 'AspNetCore'..."
          & $appcmd stop apppool /apppool.name:"AspNetCore" 2>$null
          & $appcmd start apppool /apppool.name:"AspNetCore"
          Write-Host "âœ… Local IIS Deployment completed successfully."
