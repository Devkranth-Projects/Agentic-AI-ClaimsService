name: CI-CD-Pipeline-Local-IIS-Azure

on:
  push:
    branches:
      - "Feature/**"
  pull_request:
    branches:
      - "Development"
      - "main"
  workflow_dispatch:
    inputs:
      sha_id:
        description: "Commit SHA to deploy"
        required: true
        type: string
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - Development
          - Production

env:
  DOTNET_CORE_VERSION: 8.0.x
  SOLUTION_PATH: Agentic-Ai-ClaimsService.sln
  PROJECT_PATH: ClaimsServiceApi/Health.Claims.Service.Api/Health.Claims.Service.Api.csproj
  ARTIFACT_NAME: ClaimsServiceApiBinaries

# ============================================================
# 0ï¸âƒ£ WORKFLOW SUMMARY WITH TIMESTAMPS
# ============================================================
jobs:
  workflow-summary:
    name: 0ï¸âƒ£ Workflow Summary
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“ Print workflow summary
        run: |
          echo "=============================================="
          echo "$(date '+%Y-%m-%d %H:%M:%S') â° Workflow started"
          echo "Event type: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit SHA: ${{ github.sha }}"
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Target environment: ${{ github.event.inputs.environment }}"
          fi
          echo "=============================================="

# ============================================================
# 1ï¸âƒ£ BUILD STAGE
# ============================================================
  build:
    name: 1ï¸âƒ£ Build
    runs-on: ubuntu-latest
    needs: workflow-summary
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/Feature/')) ||
      (github.event_name == 'pull_request')
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_CORE_VERSION }}

      - name: ðŸ”§ Restore NuGet Packages
        run: |
          echo -e "\e[34m$(date '+%Y-%m-%d %H:%M:%S') Step 1: Restoring NuGet packages...\e[0m"
          dotnet restore ${{ env.SOLUTION_PATH }}

      - name: ðŸ—ï¸ Build Solution
        run: |
          echo -e "\e[34m$(date '+%Y-%m-%d %H:%M:%S') Step 2: Building solution in Release mode...\e[0m"
          dotnet build ${{ env.SOLUTION_PATH }} -c Release --no-restore

      - name: ðŸ“¦ Publish Project
        run: |
          echo -e "\e[34m$(date '+%Y-%m-%d %H:%M:%S') Step 3: Publishing project...\e[0m"
          echo "Project path: ${{ env.PROJECT_PATH }}"
          echo "Output folder: ${{ runner.temp }}/publish_output"
          dotnet publish ${{ env.PROJECT_PATH }} -c Release -o ${{ runner.temp }}/publish_output

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: ${{ runner.temp }}/publish_output
          retention-days: 14

# ============================================================
# 2ï¸âƒ£ TEST STAGE
# ============================================================
  test:
    name: 2ï¸âƒ£ Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_CORE_VERSION }}

      - name: ðŸ§ª Run Domain Tests
        run: |
          echo -e "\e[33m$(date '+%Y-%m-%d %H:%M:%S') Step 4: Running Domain Tests...\e[0m"
          dotnet test "ClaimsServiceApi/Health.CLaims.Service.Domain.Tests/Health.CLaims.Service.Domain.Tests.csproj" -c Release

      - name: ðŸ§ª Run Infrastructure Tests
        run: |
          echo -e "\e[33m$(date '+%Y-%m-%d %H:%M:%S') Step 5: Running Infrastructure Tests...\e[0m"
          dotnet test "ClaimsServiceApi/Health.Claims.Service.Infrastructure.Tests/Health.Claims.Service.Infrastructure.Tests.csproj" -c Release

# ============================================================
# 3A LOCAL DEPLOYMENT (Feature Branch Push)
# ============================================================
  feature-deploy:
    name: 3A ðŸ’¾ Local IIS Deployment
    needs: test
    runs-on: self-hosted
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/Feature/')
    environment: Local
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: deploy_target

      - name: ðŸ–¥ Deploy to Local IIS
        shell: powershell
        run: |
          Write-Host "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') Step 6: Starting deployment to Local IIS..."
          $envName = "Local"
          $appcmd = "C:\Windows\System32\inetsrv\appcmd.exe"
          $targetPath = "F:\Work\Personal\Deployment\ClaimServiceApi\$envName"

          Write-Host "Cleaning target folder: $targetPath"
          if (Test-Path $targetPath) { Remove-Item "$targetPath\*" -Recurse -Force } else { New-Item -Path $targetPath -ItemType Directory }

          Write-Host "Copying published files to target folder..."
          Copy-Item "deploy_target\*" $targetPath -Recurse -Force

          # --- Environment-specific web.config replacement ---
          $envConfig = Join-Path $targetPath "web.config.$envName"
          $mainConfig = Join-Path $targetPath "web.config"

          Write-Host "Replacing web.config for environment: $envName"
          if (Test-Path $mainConfig) { Remove-Item $mainConfig -Force }
          if (Test-Path $envConfig) { Copy-Item $envConfig $mainConfig -Force }

          Write-Host "Restarting AppPool 'AspNetCore'"
          & $appcmd stop apppool /apppool.name:"AspNetCore" 2>$null
          & $appcmd start apppool /apppool.name:"AspNetCore"
          Write-Host "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') âœ… Local IIS Deployment completed successfully."

# ============================================================
# 3B TRIGGER DEVELOPMENT DEPLOYMENT (Manual Approval)
# ============================================================
  dev-trigger:
    name: 3B ðŸ”” Trigger Development Deployment
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.base_ref == 'Development'
    steps:
      - name: ðŸš€ Trigger workflow dispatch for Development
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: CI-CD-Pipeline-Local-IIS-Azure
          ref: Development
          token: ${{ secrets.GITHUB_TOKEN }}
          inputs: |
            {
              "sha_id": "${{ github.sha }}",
              "environment": "Development"
            }

# ============================================================
# 4ï¸âƒ£ APPROVED DEPLOYMENT (Development / Production)
# ============================================================
  deploy-approve:
    name: 4ï¸âƒ£ ðŸ”’ Deploy with Approval
    if: github.event_name == 'workflow_dispatch'
    runs-on: self-hosted
    environment:
      name: ${{ github.event.inputs.environment }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.event.inputs.sha_id }}
          path: deploy_target

      - name: ðŸ–¥ Deploy to IIS (Approved Environment)
        shell: powershell
        run: |
          Write-Host "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') Step 7: Starting deployment to environment: ${{ github.event.inputs.environment }}"
          $envName = "${{ github.event.inputs.environment }}"
          $appcmd = "C:\Windows\System32\inetsrv\appcmd.exe"
          $targetPath = "F:\Work\Personal\Deployment\ClaimServiceApi\$envName"

          Write-Host "Cleaning target folder: $targetPath"
          if (Test-Path $targetPath) { Remove-Item "$targetPath\*" -Recurse -Force } else { New-Item -Path $targetPath -ItemType Directory }

          Write-Host "Copying published files to target folder..."
          Copy-Item "deploy_target\*" $targetPath -Recurse -Force

          # --- Environment-specific web.config replacement ---
          # Determine environment-specific web.config
            if ($envName -eq "Development") { $envConfig = Join-Path $targetPath "web.config.Development" }
            elseif ($envName -eq "Production") { $envConfig = Join-Path $targetPath "web.config.Production" }
            elseif ($envName -eq "Local") { $envConfig = Join-Path $targetPath "web.config.Local" }

            $mainConfig = Join-Path $targetPath "web.config"

            Write-Host "ðŸ”¹ Checking if main web.config exists in $targetPath..."

            if (Test-Path $mainConfig) {
                Write-Host "âš ï¸ web.config already exists. Deleting it..."
                Remove-Item $mainConfig -Force
            }

            if (Test-Path $envConfig) {
                Write-Host "âž¡ï¸ Renaming $envConfig â†’ web.config"
                Rename-Item -Path $envConfig -NewName "web.config"
                Write-Host "âœ… Environment-specific config applied: web.config is now from $envConfig"
            } else {
                Write-Host "âŒ Environment-specific config $envConfig not found! Deployment may be incomplete."
            }

          Write-Host "Restarting AppPool 'AspNetCore'"
          & $appcmd stop apppool /apppool.name:"AspNetCore" 2>$null
          & $appcmd start apppool /apppool.name:"AspNetCore"
          Write-Host "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') âœ… Deployment to $envName completed successfully."
