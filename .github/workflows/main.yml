name: CI-CD-Pipeline-Local-IIS-Azure

on:
  push:
    branches:
      # Build/Test/Deploy now run AFTER a merge (push) to these core branches
      - 'Development'
      - 'main'
      - 'Feature/**'
      - 'Bug/**'
  pull_request:
    branches:
      # Optional: Keep PR checks for feature/bug branches if desired
      - 'Feature/**'
      - 'Bug/**'
  workflow_dispatch:
    inputs:
      sha_id:
        description: 'Commit SHA to deploy'
        required: true
        type: string
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - Development
          - Production

env:
  DOTNET_CORE_VERSION: 8.0.x
  SOLUTION_PATH: Agentic-Ai-ClaimsService.sln
  PROJECT_PATH: ClaimsServiceApi/Health.Claims.Service.Api/Health.Claims.Service.Api.csproj
  ARTIFACT_NAME: ClaimsServiceApiBinaries

jobs:
  # ============================================================
  # 1️⃣ BUILD
  # ============================================================
  build:
    name: 1️⃣ Build
    runs-on: ubuntu-latest
    # Run build for any push or pull request event
    if: |
      github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_CORE_VERSION }}

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Build solution
        run: dotnet build ${{ env.SOLUTION_PATH }} -c Release --no-restore

      - name: Publish project
        run: dotnet publish ${{ env.PROJECT_PATH }} -c Release -o ${{ runner.temp }}/publish_output

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: ${{ runner.temp }}/publish_output



  # ============================================================
  # 2️⃣ TEST
  # ============================================================
  test:
    name: 2️⃣ Run Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_CORE_VERSION }}

      - name: Run Domain Tests
        run: dotnet test "ClaimsServiceApi/Health.CLaims.Service.Domain.Tests/Health.CLaims.Service.Domain.Tests.csproj" -c Release

      - name: Run Infrastructure Tests
        run: dotnet test "ClaimsServiceApi/Health.Claims.Service.Infrastructure.Tests/Health.Claims.Service.Infrastructure.Tests.csproj" -c Release

 

  # ============================================================
  # 3️⃣ LOCAL IIS DEPLOYMENT (Feature/Bug branches)
  # * Automatically deploys to the 'Local' directory using 'web.config.Development' *
  # ============================================================
  local-deploy:
    name: 3️⃣ Local IIS Deployment (Feature/Bug)
    needs: test
    runs-on: self-hosted
    if: |
      github.event_name == 'push' && (startsWith(github.ref, 'refs/heads/Feature/') || startsWith(github.ref, 'refs/heads/Bug/'))
    environment: Local
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: deploy_target

      - name: Deploy to Local IIS
        shell: powershell
        run: |
          $envName = "Local"
          $appcmd = "C:\Windows\System32\inetsrv\appcmd.exe"
          # Target path uses the literal name "Local" for the folder
          $targetPath = "F:\Work\Personal\Deployment\ClaimServiceApi\$envName"
          $mainConfig = Join-Path $targetPath "web.config"
          # Local environment uses the Development config file
          $envConfigFile = "web.config.Development" 

          Write-Host "Starting Local IIS Deployment for branch: $envName. Config: $envConfigFile"

          # Clean and copy files
          if (Test-Path $targetPath) { Remove-Item "$targetPath\*" -Recurse -Force } else { New-Item -Path $targetPath -ItemType Directory | Out-Null }
          Write-Host "Copying published files to $targetPath..."
          Copy-Item "deploy_target\*" $targetPath -Recurse -Force

          # Handle web.config renaming
          if (Test-Path $mainConfig) { Remove-Item $mainConfig -Force }
          if (Test-Path (Join-Path $targetPath $envConfigFile)) {
              Write-Host "Renaming $envConfigFile to web.config..."
              Rename-Item (Join-Path $targetPath $envConfigFile) $mainConfig
          } else {
              Write-Host "Warning: $envConfigFile not found, skipping rename."
          }

          # Restart IIS AppPool
          Write-Host "Restarting IIS AppPool 'AspNetCore'..."
          & $appcmd stop apppool /apppool.name:"AspNetCore" 2>$null
          & $appcmd start apppool /apppool.name:"AspNetCore"
          Write-Host "Local IIS deployment completed successfully."



  # ============================================================
  # 4️⃣ MAIN DEPLOYMENT (Development/Main → Requires Approval)
  # * Triggered by merge. Deploys to Development or Production folder/config. *
  # ============================================================
  main-deploy:
    name: 4️⃣ Main Deployment (Approved)
    needs: test
    runs-on: self-hosted
    # Only runs on push (merge) to Development or main branches
    if: |
      github.event_name == 'push' && (github.ref == 'refs/heads/Development' || github.ref == 'refs/heads/main')
    
    # Assigns the GitHub Environment based on the branch (Dev or Prod)
    environment:
      name: ${{ github.ref == 'refs/heads/Development' && 'Development' || 'Production' }}
      
    steps:
      # Use github.sha (the SHA of the merge commit) for the artifact
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: deploy_target

      - name: Deploy to IIS (Approved Env)
        shell: powershell
        run: |
          # Determine environment variables based on the branch reference
          $isDevelopment = ("${{ github.ref }}" -eq "refs/heads/Development")
          $envName = if ($isDevelopment) { "Development" } else { "Production" }
          $appcmd = "C:\Windows\System32\inetsrv\appcmd.exe"
          # Target path uses the folder name matching the environment name (Development or Production)
          $targetPath = "F:\Work\Personal\Deployment\ClaimServiceApi\$envName"
          $mainConfig = Join-Path $targetPath "web.config"

          # Determine the correct config file based on environment
          $envConfigFile = if ($isDevelopment) { "web.config.Development" } else { "web.config.Production" }

          Write-Host "Starting approved deployment to environment: $envName. Config: $envConfigFile"

          # Clean and copy files
          if (Test-Path $targetPath) { Remove-Item "$targetPath\*" -Recurse -Force } else { New-Item -Path $targetPath -ItemType Directory | Out-Null }
          Write-Host "Copying published files to $targetPath..."
          Copy-Item "deploy_target\*" $targetPath -Recurse -Force

          # Handle web.config renaming
          if (Test-Path $mainConfig) { Remove-Item $mainConfig -Force }
          if (Test-Path (Join-Path $targetPath $envConfigFile)) {
              Write-Host "Renaming $envConfigFile to web.config..."
              Rename-Item (Join-Path $targetPath $envConfigFile) $mainConfig
          } else {
              Write-Host "Warning: $envConfigFile not found, skipping rename."
          }

          # Restart IIS AppPool
          Write-Host "Restarting IIS AppPool 'AspNetCore'..."
          & $appcmd stop apppool /apppool.name:"AspNetCore" 2>$null
          & $appcmd start apppool /apppool.name:"AspNetCore"
          Write-Host "Deployment to $envName completed successfully."
  
  

  # ============================================================
  # 5️⃣ MANUAL RE-DEPLOY (Workflow Dispatch)
  # * Uses the user-specified environment (Development or Production) *
  # ============================================================
  manual-redeploy:
    name: 5️⃣ Manual Redeploy (Approved)
    needs: test
    runs-on: self-hosted
    if: github.event_name == 'workflow_dispatch' 
    environment:
      name: ${{ github.event.inputs.environment }}
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.event.inputs.sha_id }}
          path: deploy_target

      - name: Deploy to IIS (Manual)
        shell: powershell
        run: |
          $envName = "${{ github.event.inputs.environment }}"
          $isDevelopment = ($envName -eq "Development")
          $appcmd = "C:\Windows\System32\inetsrv\appcmd.exe"
          # Target path uses the folder name matching the environment name (Development or Production)
          $targetPath = "F:\Work\Personal\Deployment\ClaimServiceApi\$envName"
          $mainConfig = Join-Path $targetPath "web.config"

          # Determine the correct config file based on environment
          $envConfigFile = if ($isDevelopment) { "web.config.Development" } else { "web.config.Production" }

          Write-Host "Starting manual re-deployment to environment: $envName. Config: $envConfigFile"

          # Clean and copy files
          if (Test-Path $targetPath) { Remove-Item "$targetPath\*" -Recurse -Force } else { New-Item -Path $targetPath -ItemType Directory | Out-Null }
          Write-Host "Copying published files to $targetPath..."
          Copy-Item "deploy_target\*" $targetPath -Recurse -Force

          # Handle web.config renaming
          if (Test-Path $mainConfig) { Remove-Item $mainConfig -Force }
          if (Test-Path (Join-Path $targetPath $envConfigFile)) {
              Write-Host "Renaming $envConfigFile to web.config..."
              Rename-Item (Join-Path $targetPath $envConfigFile) $mainConfig
          } else {
              Write-Host "Warning: $envConfigFile not found, skipping rename."
          }

          # Restart IIS AppPool
          Write-Host "Restarting IIS AppPool 'AspNetCore'..."
          & $appcmd stop apppool /apppool.name:"AspNetCore" 2>$null
          & $appcmd start apppool /apppool.name:"AspNetCore"
          Write-Host "Manual redeployment to $envName completed successfully."