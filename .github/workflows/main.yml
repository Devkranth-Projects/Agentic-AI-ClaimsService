name: CI-CD-Pipeline-Local-IIS-Azure

on:
  push:
    branches:
      - 'Feature/**'
      - 'Bug/**'
      - 'Development'
      - 'main'
  workflow_dispatch:
    inputs:
      sha_id:
        description: 'Commit SHA to deploy'
        required: true
        type: string
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - Development
          - Production

env:
  DOTNET_CORE_VERSION: 8.0.x
  SOLUTION_PATH: Agentic-Ai-ClaimsService.sln
  PROJECT_PATH: ClaimsServiceApi/Health.Claims.Service.Api/Health.Claims.Service.Api.csproj
  ARTIFACT_NAME: ClaimsServiceApiBinaries

jobs:
  # ============================================================
  # 1ï¸âƒ£ BUILD STAGE
  # ============================================================
  build:
    name: 1ï¸âƒ£ Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_CORE_VERSION }}

      - name: Restore NuGet Packages
        run: |
          echo "ðŸ”¹ Step 1: Restoring NuGet packages for solution ${{ env.SOLUTION_PATH }}..."
          dotnet restore ${{ env.SOLUTION_PATH }}
          echo "âœ… NuGet restore completed."

      - name: Build Solution
        run: |
          echo "ðŸ”¹ Step 2: Building solution ${{ env.SOLUTION_PATH }} in Release mode..."
          dotnet build ${{ env.SOLUTION_PATH }} -c Release --no-restore
          echo "âœ… Build completed successfully."

      - name: Publish Project
        run: |
          echo "ðŸ”¹ Step 3: Publishing project ${{ env.PROJECT_PATH }}..."
          echo "ðŸ”¹ Output folder: ${{ runner.temp }}/publish_output"
          dotnet publish ${{ env.PROJECT_PATH }} -c Release -o ${{ runner.temp }}/publish_output
          echo "âœ… Publish completed. Files are available at ${{ runner.temp }}/publish_output."

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: ${{ runner.temp }}/publish_output
        run: echo "âœ… Build artifacts uploaded successfully."

  # ============================================================
  # 2ï¸âƒ£ TEST STAGE
  # ============================================================
  test:
    name: 2ï¸âƒ£ Run Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_CORE_VERSION }}

      - name: Run Domain Tests
        run: |
          echo "ðŸ”¹ Step 4: Running Domain Tests..."
          dotnet test "ClaimsServiceApi/Health.CLaims.Service.Domain.Tests/Health.CLaims.Service.Domain.Tests.csproj" -c Release
          echo "âœ… Domain tests completed."

      - name: Run Infrastructure Tests
        run: |
          echo "ðŸ”¹ Step 5: Running Infrastructure Tests..."
          dotnet test "ClaimsServiceApi/Health.Claims.Service.Infrastructure.Tests/Health.Claims.Service.Infrastructure.Tests.csproj" -c Release
          echo "âœ… Infrastructure tests completed."

  # ============================================================
  # 3ï¸âƒ£ LOCAL IIS DEPLOYMENT (Feature/Bug branches, skip approval)
  # ============================================================
  local-deploy:
    name: 3ï¸âƒ£ Local IIS Deployment
    needs: test
    runs-on: self-hosted
    if: startsWith(github.ref, 'refs/heads/Feature/') || startsWith(github.ref, 'refs/heads/Bug/')
    environment: Local
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: deploy_target

      - name: Deploy to Local IIS
        shell: powershell
        run: |
          $envName = "Local"
          $appcmd = "C:\Windows\System32\inetsrv\appcmd.exe"
          $targetPath = "F:\Work\Personal\Deployment\ClaimServiceApi\$envName"

          Write-Host "ðŸ”¹ Step 6: Starting Local IIS Deployment to environment: $envName"
          Write-Host "ðŸ”¹ Target path: $targetPath"

          if (Test-Path $targetPath) {
              Write-Host "ðŸ”¹ Cleaning existing files in target directory..."
              Remove-Item "$targetPath\*" -Recurse -Force
          } else {
              Write-Host "ðŸ”¹ Creating target directory..."
              New-Item -Path $targetPath -ItemType Directory
          }

          Write-Host "ðŸ”¹ Copying published files to IIS directory..."
          Copy-Item "deploy_target\*" $targetPath -Recurse -Force

          # Handle web.config
          $envConfig = Join-Path $targetPath "web.config.Development"
          $prodConfig = Join-Path $targetPath "web.config.Production"
          $mainConfig = Join-Path $targetPath "web.config"

          if (Test-Path $mainConfig) {
              Write-Host "ðŸ”¹ Removing existing web.config..."
              Remove-Item $mainConfig -Force
          }

          if ($envName -eq "Local" -and Test-Path $envConfig) {
              Write-Host "ðŸ”¹ Renaming web.config.Development to web.config..."
              Rename-Item $envConfig $mainConfig
          } elseif (Test-Path $prodConfig) {
              Write-Host "ðŸ”¹ Renaming web.config.Production to web.config..."
              Rename-Item $prodConfig $mainConfig
          }

          Write-Host "ðŸ”¹ Restarting IIS AppPool 'AspNetCore'..."
          & $appcmd stop apppool /apppool.name:"AspNetCore" 2>$null
          & $appcmd start apppool /apppool.name:"AspNetCore"

          Write-Host "âœ… Local IIS Deployment completed successfully."

  # ============================================================
  # 4ï¸âƒ£ APPROVED DEPLOYMENT (Development/Main merges)
  # ============================================================
  deploy-approve:
    name: 4ï¸âƒ£ Approved Environment Deployment
    needs: test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/Development' || github.ref == 'refs/heads/main'
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'Production' || 'Development' }}
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: deploy_target

      - name: Deploy to IIS (Approved Environment)
        shell: powershell
        run: |
          $envName = "${{ github.ref == 'refs/heads/main' && 'Production' || 'Development' }}"
          $appcmd = "C:\Windows\System32\inetsrv\appcmd.exe"
          $targetPath = "F:\Work\Personal\Deployment\ClaimServiceApi\$envName"

          Write-Host "ðŸ”¹ Step 7: Deployment to environment: $envName"
          Write-Host "ðŸ”¹ Target path: $targetPath"

          if (Test-Path $targetPath) {
              Write-Host "ðŸ”¹ Cleaning existing files in target directory..."
              Remove-Item "$targetPath\*" -Recurse -Force
          } else {
              Write-Host "ðŸ”¹ Creating target directory..."
              New-Item -Path $targetPath -ItemType Directory
          }

          Write-Host "ðŸ”¹ Copying published files..."
          Copy-Item "deploy_target\*" $targetPath -Recurse -Force

          # Handle web.config
          $envConfig = Join-Path $targetPath "web.config.Development"
          $prodConfig = Join-Path $targetPath "web.config.Production"
          $mainConfig = Join-Path $targetPath "web.config"

          if (Test-Path $mainConfig) {
              Write-Host "ðŸ”¹ Removing existing web.config..."
              Remove-Item $mainConfig -Force
          }

          if ($envName -eq "Development" -and Test-Path $envConfig) {
              Write-Host "ðŸ”¹ Renaming web.config.Development to web.config..."
              Rename-Item $envConfig $mainConfig
          } elseif ($envName -eq "Production" -and Test-Path $prodConfig) {
              Write-Host "ðŸ”¹ Renaming web.config.Production to web.config..."
              Rename-Item $prodConfig $mainConfig
          }

          Write-Host "ðŸ”¹ Restarting IIS AppPool 'AspNetCore'..."
          & $appcmd stop apppool /apppool.name:"AspNetCore" 2>$null
          & $appcmd start apppool /apppool.name:"AspNetCore"

          Write-Host "âœ… Deployment to $envName completed successfully. Awaiting GitHub approval if required."
